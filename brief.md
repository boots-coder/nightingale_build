# 完整项目简报 (Project Brief)

## 项目名称: Nightingale VoiceAI 患者体验原型
## 候选人: <Jia Haoxuan>
## 提交日期: 2025年10月1日


### 1. 项目目标 (Objective)
本原型旨在解决现代临床环境中**信息过载和沟通鸿沟**的核心痛点。通过构建一个以**隐私和可追溯性**为基石的语音AI工作流，本项目致力于将冗长的医患对话，转化为**精确、可信且对医患双方都有价值的结构化信息**，从而提升诊疗效率和患者满意度。


### 2. 核心架构 (Core Architecture)
#### A. 系统数据流
本原型采用**简洁高效的单体API架构**，核心数据流如下：

`[用户输入: 文本/未来可扩展为音频]` -> `[FastAPI Endpoint: /process]` -> `[核心处理层]` -> `[SQLite数据库]` -> `[API响应: 结构化JSON]`

核心处理层包含两个关键的**异步模块**：
- **脱敏模块 (Redaction)**：在信息处理早期，使用spaCy的**命名实体识别（NER）**技术，识别并遮蔽PHI（受保护健康信息），确保敏感数据不会泄露到日志或下游服务。
- **摘要与溯源模块 (Summarization & Provenance)**：
  1. 首先将原文分解为**带编号的句子**。
  2. 通过精心设计的Prompt，引导GPT模型生成两种摘要，并强制要求模型在每个论点后附上**来源句子编号 [S#]**。
  3. 最后，通过正则表达式解析这些锚点，将摘要内容和溯源关系一同存入数据库。


#### B. 数据库 Schema
数据库设计遵循**关系型范式**，确保数据的一致性和可扩展性：
- `Consultations`：存储每一次咨询的基础信息，如患者ID和原始对话稿。
- `Summaries`：存储由一次咨询生成的多个摘要（如临床医生版和患者版），通过外键与`Consultations`表关联。
- `ProvenanceAnchors`：存储摘要内容与原文句子之间的映射关系，通过外键与`Summaries`表关联。这是实现“**来源可追溯性**”的数据基石。


### 3. 关键决策与技术权衡 (Key Decisions & Trade-offs)
#### 技术选型:
- **FastAPI**：其高性能、基于Pydantic的自动数据校验和开箱即用的Swagger UI文档，是48小时内完成高质量API开发的关键。
- **SQLAlchemy + SQLite**：提供了强大的ORM功能，同时SQLite的**零配置特性**，使开发能专注于业务逻辑而非环境搭建。


#### 核心权衡：来源可追溯性的实现深度
- **决策**：在数据库中，完整实现了从“摘要”到“句子编号 (anchor_id)”的映射关系，但将“句子编号”到“原文精确字符位置 (source_span_start/end)”的功能设为**简化处理**（统一存为0）。
- **理由**：这是本次挑战中最重要的工程权衡。在有限时间内，**证明“摘要论点可被追溯至特定句子”是来源可追溯性的核心**，该实现100%完成了这一点。存储精确的字符位置主要是为了前端高亮，属于“锦上添花”的功能。此决策确保了在截止日期前，能交付一个**核心价值明确且稳健可靠**的原型。


### 4. 摘要设计对比 (Summary Design Comparison)

| 临床医生摘要 (Clinician) | 患者摘要 (Patient) |
|--------------------------|--------------------|
| `{"subjective": "患者主诉头晕，持续约两周，晨起时加重 [S0, S2]。", "plan": "建议进行头部CT检查，并监测血压 [S4]。"}` | `{"greeting": "你好！我们总结了几个要点：", "points": ["您最近两周感觉头晕，特别是早上 [S0, S2]。"], "next_steps": "医生建议您接下来做一个头部CT检查..."}` |


- **临床医生摘要**：严格遵循**SOAP格式**，信息密度高，术语专业，便于医生快速浏览并纳入电子病历（EMR），最大化提升效率。
- **患者摘要**：采用**对话式、分点的友好格式**，语言通俗易懂，并提供明确的“下一步行动”，旨在降低患者的理解门槛和焦虑感，使其成为一个可信赖的“健康助手”。


### 5. 遇到的挑战与解决方案 (Challenge Encountered & Solution)
- **挑战**：最初，为溯源锚点设计的解析逻辑 `re.findall(r'\[S(\d+)\]')` 过于简单。单元测试 (`test_grounding.py`) 明确暴露了其缺陷：当模型返回 `[S0, S1]` 这种一个锚点引用多个来源的复杂格式时，该逻辑会完全失效，导致溯源信息丢失。

- **解决方案**：将解析逻辑重构为**更稳健的两步法**：
  1. 首先，使用 `re.findall(r'\[S[^\]]*\]')` 捕获所有完整的 `[S...]` 块。
  2. 然后，遍历这些块，并从每个块内部使用 `re.findall(r'\d+')` 提取所有数字。

  该方案不仅修复了Bug，还极大地增强了系统的**鲁棒性**，能够从容应对AI输出的微小格式变化。这次经历也让我深刻体会到，对于处理AI模型这种**非确定性输出**，编写单元测试是保证系统可靠性的必要手段。


### 6. 未来改进方向 (Future Improvements)
- **完整的锚点高亮功能**：基于数据库中已预留的 `source_span_start/end` 字段，在后端实现精确的字符位置映射。前端可通过这些坐标，在用户点击摘要锚点时，实现原文对应句子的**动态高亮**，提供极致的可追溯性体验。
- **添加合适的前端页面**：开发一个简洁的React或Vue前端应用，提供文件上传、状态显示、以及结构化展示双摘要和可点击锚点的交互界面，将后端API的能力完整地呈现给用户。
- **集成实时语音识别模块**：将目前的文件上传模式，升级为通过WebSockets与前端连接的**实时语音流处理**。集成如Deepgram或AssemblyAI等流式语音识别服务，实现“边说边转录”，满足真实诊疗场景的需求。